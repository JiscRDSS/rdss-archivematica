---
version: "2"

services:

  # Override main nginx config, enabling Shibboleth for Archivematica services
  # which both run on port 443
  nginx:
    image: "arkivum/shibboleth-nginx:${DOMAIN_NAME}"
    build:
      context: "./am-shib/nginx/"
      args:
        - NGINX_CONF_TEMPLATE_FILE=templates/am-shib.conf.tpl
        - SHIBBOLETH_CONF_TEMPLATE_FILE=templates/shibboleth2.xml.tpl
    networks:
      default:
          aliases:
            - "dashboard.archivematica.${DOMAIN_NAME}"
            - "ss.archivematica.${DOMAIN_NAME}"
      shibnet:
          aliases:
            - "dashboard.archivematica.${DOMAIN_NAME}"
            - "ss.archivematica.${DOMAIN_NAME}"

    environment:
      # The hostname of the nginx server serving Archivematica
      AM_DASHBOARD_HOST: "dashboard.archivematica.${DOMAIN_NAME}"
      AM_STORAGE_SERVICE_HOST: "ss.archivematica.${DOMAIN_NAME}"
      # Shibboleth FastCGI SP config
      SHIBBOLETH_IDP_ENTITY_ID: "https://idp.${DOMAIN_NAME}/idp/shibboleth"
      SHIBBOLETH_IDP_METADATA_URL: "https://idp.${DOMAIN_NAME}:${IDP_EXTERNAL_PORT}/idp/shibboleth"
      # Metadata config - set URL subst to same as IdP metadata URL for our local IDP
      SHIBBOLETH_METADATA_SIGNING_CERT: "/etc/shibboleth/md-signing.crt"
      SHIBBOLETH_METADATA_URL_SUBST: "https://idp.${DOMAIN_NAME}:${IDP_EXTERNAL_PORT}/idp/shibboleth"
      # Deployment settings
      AM_EXTERNAL_PORT:
    volumes:
      - "${VOL_BASE}/am-shib/build/secrets/:/secrets/:ro"
      - "${VOL_BASE}/../shib-local/build/secrets/idp/idp.${DOMAIN_NAME}.crt:/etc/shibboleth/md-signing.crt:ro"
    ports:
      - "${NGINX_EXTERNAL_IP}:${AM_EXTERNAL_PORT}:443"
    depends_on:
      - "archivematica-dashboard"
      - "archivematica-storage-service"

  archivematica-dashboard:
    environment:
      ARCHIVEMATICA_DASHBOARD_SHIBBOLETH_AUTHENTICATION: "True"

  archivematica-storage-service:
    environment:
      SS_SHIBBOLETH_AUTHENTICATION: "True"

networks:
  shibnet:
    driver: "bridge"