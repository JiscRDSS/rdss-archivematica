---
version: "2"

services:

  # Override main nginx config, enabling Shibboleth for Archivematica services
  # Dashboard runs on 443 and Storage Service on 8443
  nginx:
    image: "arkivum/shibboleth-nginx:${DOMAIN_NAME}"
    build:
      context: "./am-shib/nginx/"
      args:
        - DOMAIN_NAME
        - NGINX_CONF_TEMPLATE_FILE=templates/am-shib.conf.tpl
        - SHIBBOLETH_ATTRCHECKER_TEMPLATE_FILE=templates/attrChecker.html.tpl
        - SHIBBOLETH_CONF_TEMPLATE_FILE=templates/shibboleth2.xml.tpl
    container_name: "archivematica.${DOMAIN_NAME}"
    hostname: "archivematica"
    domainname: "${DOMAIN_NAME}"
    networks:
      - "default"
      - "shibnet"
    environment:
      # The hostname of the nginx server serving Archivematica
      NGINX_HOSTNAME: "archivematica.${DOMAIN_NAME}"
      # Shibboleth FastCGI SP config
      SHIBBOLETH_IDP_ENTITY_ID: "https://idp.${DOMAIN_NAME}/idp/shibboleth"
      SHIBBOLETH_IDP_METADATA_URL: "https://idp.${DOMAIN_NAME}:4443/idp/shibboleth"
    volumes:
      #
      # Nginx
      #
      # Add Shibboleth FastCGI config
      - "./am-shib/etc/nginx/shib_clear_headers:/etc/nginx/shib_clear_headers:ro"
      - "./am-shib/etc/nginx/shib_fastcgi_params:/etc/nginx/shib_fastcgi_params:ro"
      # Override the default nginx archivematica config with ones for Shibboleth
      - "./am-shib/etc/nginx/archivematica.conf:/etc/nginx/conf.d/archivematica.conf:ro"
      - "./am-shib/etc/nginx/am-shib.inc:/etc/nginx/conf.d/am-shib.inc:ro"
      #
      # Shibboleth
      #
      # Add Shibboleth customizations
      - "./am-shib/etc/sp/attrChecker.pl:/etc/shibboleth/attrChecker.pl:ro"
      - "./am-shib/etc/sp/console.logger:/etc/shibboleth/console.logger:ro"
      - "./am-shib/etc/sp/security-policy.xml:/etc/shibboleth/security-policy.xml:ro"
      - "./am-shib/etc/sp/shibd.logger:/etc/shibboleth/shibd.logger:ro"
      # Override the default Shibboleth attribute-map, so we get the right attributes exposed
      - "./am-shib/etc/sp/attribute-map.xml:/etc/shibboleth/attribute-map.xml:ro"
      #
      # Supervisor
      #
      # Override the default Supervisor config to add additional programs
      - "./am-shib/etc/supervisor/shibboleth.conf:/etc/supervisor/conf.d/shibboleth.conf:ro"
      #
      # Secrets
      #
      - "./am-shib/build/secrets/:/secrets/:ro"
      #
      # Bootstrap
      #
      - "./am-shib/nginx/bootstrap.sh:/usr/sbin/bootstrap.sh:ro"
    command: ["/usr/local/bin/ep",
      "-v", "/etc/nginx/conf.d/am-shib.conf", "/etc/shibboleth/shibboleth2.xml",
      "--",
      "/bin/sh", "-c",
      "bootstrap.sh && /usr/bin/supervisord --nodaemon --configuration /etc/supervisor/supervisord.conf"
    ]
    expose:
      - "443"
      - "8443"
    ports:
      - "${NGINX_EXTERNAL_IP}:443:443"
      - "${NGINX_EXTERNAL_IP}:8443:8443"
    depends_on:
      - "archivematica-dashboard"
      - "archivematica-storage-service"

  archivematica-dashboard:
    environment:
      ARCHIVEMATICA_DASHBOARD_SHIBBOLETH_AUTHENTICATION: "True"

  archivematica-storage-service:
    environment:
      SS_SHIBBOLETH_AUTHENTICATION: "True"

networks:
  shibnet:
    driver: "bridge"