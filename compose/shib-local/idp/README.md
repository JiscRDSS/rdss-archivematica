Shibboleth-enabled Archivematica: IdP Service
==============================================

The IdP service includes the [Shibboleth Identity Provider](https://shibboleth.net/products/identity-provider.html), running in a Jetty container.

The IdP does not ship with a default configuration - instead an install script is provided to create a `customized-shibboleth-idp` directory that is then expected to be modified manually to customize the IdP to meet requirements. This is fine unless the installation is being automated - we want to be able to bring up containers unattended, if need be.

This container uses the `arkivum/shibboleth-idp` image, which extends the [unicorn/shibboleth-idp](https://hub.docker.com/r/unicon/shibboleth-idp/) image, and uses CentOS 7 as its base image.

Building
---------

The image for this service is done as part of the `docker-compose build` task. However, prior to that, the IdP needs configuring, which is what the `build-idp` target in the [makefile](../Makefile) does.

The IdP itself provides an install wizard that helps you to get set up. The recommended way of setting up the `unicon/shibboleth-idp` image is to run it using `docker run` and specify a directory on the host as a volume mount so that the config files generated by the installer are available after the docker instance has stopped. For example:

	docker run --rm -it -v .:/ext-mount unicon/shibboleth-idp

Unfortunately, when this is run it asks a bunch of questions to help with the set up - not helpful for automatic deployments.

The [init-idp.sh](bin/init-idp.sh) script helps to overcome this. It provides answers to the questions via command line arguments, properties files and environment variables to avoid any interaction being required. We run it like this as part of the build:

	@docker run --rm \
		-h idp.$(DOMAIN_NAME) \
		--volume "$(VOL_BASE)/shib-local/idp/bin:/setup/bin:ro" \
		--volume "$(VOL_BASE)/shib-local/etc/idp:/setup/conf:ro" \
		--volume "$(VOL_BASE)/shib-local/build/idp/:/ext-mount" \
		-e DOMAIN_NAME=$(DOMAIN_NAME) \
		-e IDP_EXTERNAL_PORT=$(IDP_EXTERNAL_PORT) \
		-e IDP_HOSTNAME=$(IDP_HOSTNAME) \
		-e IDP_LDAP_HOSTNAME=$(IDP_LDAP_HOSTNAME) \
		-e IDP_OWNER_UID=$(shell id -u) \
		-e IDP_OWNER_GID=$(shell id -g) \
		unicon/shibboleth-idp /setup/bin/init-idp.sh

The additional volumes give us our script and its [config](../etc/idp) files, whilst the hostname and environment variable ensure that the generated config has the right parameters for certificates etc.

The only config file relevant to the `init-idp.sh` script is [idp.properties.tpl](../etc/idp/idp.properties.tpl) which is a templated properties file used to configure the IdP. This template includes environment variables which are replaced using `sed` before being passed to the installer.

The output of the installer is put into the `build/customized-shibboleth-idp` folder on the Docker host machine.

Aside from running the installer to generate the config, the build script also creates and updates the certificates and keys used for SSL, encryption and signing. These certificates are signed by the [CA](../ca) for the domain.

Configuration
--------------

Most of the configuration files for the IdP are generated by the installer. There are a few that are overriden, which are in the [etc](../etc/idp) folder. These are:

* [attribute-filter.xml](../etc/idp/attribute-filter.xml)
* [attribute-resolver.xml](../etc/idp/attribute-resolver.xml)
* [ldap.properties](../etc/idp/ldap.properties)

The `attribute-resolver.xml` file configures how the IdP resolves the attributes for a user that it can share with an SP. In the current configuration, the attributes are resolved by looking up in our [ldap](../ldap) service, and the attributes given relate to the eduPerson schema used by the LDAP records. Details of this configuration file are available [here](https://wiki.shibboleth.net/confluence/display/IDP30/AttributeResolverConfiguration).

The `attribute-filter.xml` file configures how the IdP filters the attributes it retrieves from the configured data connector(s) (i.e. LDAP) before sharing them with an SP. The current configuration is very simple, allowing all available attributes to be shared with any SP requesting them. This can of course be changed; details of this configuration file are available [here](https://wiki.shibboleth.net/confluence/display/IDP30/AttributeFilterConfiguration).

Finally, the `ldap.properties` file configures how the IdP connects to the LDAP directory service to lookup user credentials. The main thing here is setting the baseDN and bindDN to match the installation environment - in particular getting the domain name right and lookup credentials right. Further information about LDAP configuration can be found [here](https://wiki.shibboleth.net/confluence/display/IDP30/LDAPAuthnConfiguration).

More details of the IdP and its configuration are available in the [official documentation](https://wiki.shibboleth.net/confluence/display/IDP30/).

In addition, the [service-providers.json](../etc/idp/service-providers.json) file is used at build-time as input to the [idp-metadata-providers.py](../../shib/idp-metadata-providers.py) script to generate the required `metadata-providers.xml` used by the IdP to describe the SPs it knows about.

In this Archivematica Shibboleth deployment, we have two SPs: one for the Archivematica Dashboard and one for the Archivematica Storage Service. Although part of the same product they run on different ports they have different endpoints, hence it is simplest to treat them as different SPs as far as the IdP is concerned.

In reality, the Dashboard and Storage Service are both serviced by the same SP; see the [nginx](../../am-shib/nginx) service for details.

Environment Variables
----------------------

The following environment variables are used by this service:

| Variable | Description | Default Value |
|---|---|
| `AM_DASHBOARD_HOST` | Hostname for the Archivematica Dashboard. | `dashboard.archivematica.example.ac.uk`. |
| `AM_EXTERNAL_PORT` | External port that the Archivematica Dashboard should be exposed on - required . | `443` |
| `AM_STORAGE_SERVICE_HOST` | Hostname for the Archivematica Storage Service. | `ss.archivematica.example.ac.uk` |
| `DOMAIN_NAME` | Domain name to use for this IdP. This becomes the Shibboleth "scope", i.e. the domain that is 'managed' by this IdP. | `example.ac.uk` |
| `IDP_EXTERNAL_PORT` | External port that the IdP is exposed on. | `4443` |
| `IDP_SSL_CA_CERT_FILE` | Path of the CA certificate file to secure the IdP with. | `/secrets/${DOMAIN_NAME}-ca.crt` |
| `IDP_SSL_CERT_FILE` | Path of the certificate file to secure the IdP with. | `/secrets/${DOMAIN_NAME}.crt` |
| `IDP_SSL_KEY_FILE` | Path of the private key file to secure the IdP with. | `/secrets/${DOMAIN_NAME}.key` |
| `IDP_SSL_KEYSTORE_PASSWORD` | Password to use for the IdP's internal keystore. | `12345` |

## Important Note

Previous versions supported additional environment variables that are no longer supported:

* `AM_DASHBOARD_EXTERNAL_PORT` and `AM_STORAGE_SERVICE_EXTERNAL_PORT` have now been replaced by `AM_EXTERNAL_PORT`
* `NGINX_HOSTNAME` has been replaced by `AM_DASHBOARD_HOST` and `AM_STORAGE_SERVICE_HOST`

SSL Certificates
-----------------

The IdP is secured using SSL certificates. If none are provided, a private key and the associated self-signed certificates are generated and used.

To use a custom key and certificates, you must set the `IDP_SSL_*` parameters on the container, and mount the referenced files into the container instance. For example, using docker-compose:

```
services:
  idp:
    environment:
      IDP_SSL_KEY_FILE: '/secrets/my-private-key.pem'
      IDP_SSL_CERT_FILE: '/secrets/my-certificate.pem'
      IDP_SSL_CA_CERT_FILE: '/secrets/my-ca-certificate.pem'
    volumes:
      - '/keys/my-private-key.pem:/secrets/my-private-key.pem:ro'
      - '/keys/my-certificate.pem:/secrets/my-certificate.pem:ro'
      - '/keys/my-ca-certificate.pem:/secret/my-ca-certificate.pem:ro'
```

Note that if your certificate chain requires intermediate certificates then these should be bundled into the file given by the `IDP_SSL_CA_CERT_FILE` variable.

All key and certificate files must be in PEM format.


UI Customization
-----------------

The IdP runs as a web application and presents a user interface for sign in etc. The current configuration uses a very basic (default) template with a couple of minor customizations to the logo and message text.

The logo image is in the [images](../etc/idp/images) folder. The path to the file, along with a few other text strings, is set in the [messages](../etc/idp/messages/messages.properties) file, which is merged with the main system messages file at runtime.

At the moment the IdP presents itself as "Example University". If this needs to be changed then the [messages.properties](../etc/idp/messages/messages.properties) is the place to do it (it could be made more dynamic but this would require the logo image to be selected/generated too, which is not core to the purpose of this IdP container).

