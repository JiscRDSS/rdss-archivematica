Shibboleth: Common IdP Service
===============================

The IdP service includes the [Shibboleth Identity Provider](https://shibboleth.net/products/identity-provider.html), running in a Jetty container.

The IdP does not ship with a default configuration - instead an install script is provided to create a `customized-shibboleth-idp` directory that is then expected to be modified manually to customize the IdP to meet requirements. This is fine unless the installation is being automated - we want to be able to bring up containers unattended, if need be.

This container uses the `arkivum/shibboleth-idp` image, which extends the [unicorn/shibboleth-idp](https://hub.docker.com/r/unicon/shibboleth-idp/) image, and uses CentOS 7 as its base image.

The configuration here is intended to be "abstract" - additional config files are required for the service to work. The [am-shib IdP](../../am-shib/idp) and [example-shib IdP](../../example-shib/idp) are examples of this.

Building
---------

The image build itself is expected to be done by the `docker-compose build` task when processing a compose config file. However, prior to that, the IdP needs configuring, which is what the [build script](build.sh) does:

	./build.sh

The IdP itself provides an install wizard that helps you to get set up. The recommended way of setting up the `unicon/shibboleth-idp` image is to run it using `docker run` and specify a directory on the host as a volume mount so that the config files generated by the installer are available after the docker instance has stopped. For example:

	docker run --rm -it -v .:/ext-mount unicon/shibboleth-idp

Unfortunately, when this is run it asks a bunch of questions to help with the set up - not helpful for automatic deployments.

The [init-idp.sh](bin/init-idp.sh) script helps to overcome this. It provides answers to the questions via command line arguments, properties files and environment variables to avoid any interaction being required. We run it like this as part of the build script:

	docker run --rm -it \
		-h ${IDP_HOSTNAME} \
		-v $(pwd)/bin:/setup/bin \
		-v $(pwd)/conf:/setup/conf \
		-v ${BUILD_DIR}:/ext-mount \
		-e DOMAIN_NAME=${DOMAIN_NAME} \
		unicon/shibboleth-idp /setup/bin/init-idp.sh

The additional volumes give us our script and its [config](conf) files, whilst the hostname and environment variable ensure that the generated config has the right parameters for certificates etc.

The only config file relevant to the `init-idp.sh` script is [idp.properties.tpl](conf/idp.properties.tpl) which is a templated properties file used to configure the IdP. This template includes environment variables which are replaced using `sed` before being passed to the installer.

The output of the installer is put into the `build/customized-shibboleth-idp` folder on the Docker host machine.

Aside from running the installer to generate the config, the build script also creates and updates the certificates and keys used for SSL, encryption and signing. These certificates are signed by the [CA](../ca) for the domain.

Configuration
--------------

Most of the configuration files for the IdP are generated by the installer. There are a few that are overriden, which are in the [conf](conf) folder. These are:

* [attribute-filter.xml](conf/attribute-filter.xml)
* [attribute-resolver.xml](conf/attribute-resolver.xml)
* [ldap.properties](conf/ldap.properties)

The `attribute-resolver.xml` file configures how the IdP resolves the attributes for a user that it can share with an SP. In the current configuration, the attributes are resolved by looking up in our [ldap](../ldap) service, and the attributes given relate to the eduPerson schema used by the LDAP records. Details of this configuration file are available [here](https://wiki.shibboleth.net/confluence/display/IDP30/AttributeResolverConfiguration).

The `attribute-filter.xml` file configures how the IdP filters the attributes it retrieves from the configured data connector(s) (i.e. LDAP) before sharing them with an SP. The current configuration is very simple, allowing all available attributes to be shared with any SP requesting them. This can of course be changed; details of this configuration file are available [here](https://wiki.shibboleth.net/confluence/display/IDP30/AttributeFilterConfiguration).

Finally, the `ldap.properties` file configures how the IdP connects to the LDAP directory service to lookup user credentials. The main thing here is setting the baseDN and bindDN to match the installation environment - in particular getting the domain name right and lookup credentials right. Further information about LDAP configuration can be found [here](https://wiki.shibboleth.net/confluence/display/IDP30/LDAPAuthnConfiguration).

More details of the IdP and its configuration are available in the [official documentation](https://wiki.shibboleth.net/confluence/display/IDP30/).

UI Customization
-----------------

The IdP runs as a web application and presents a user interface for sign in etc. The current configuration uses a very basic (default) template with a couple of minor customizations to the logo and message text.

The logo image is in the [images](images) folder. The path to the file, along with a few other text strings, is set in the [messages](messages/messages.properties) file, which is merged with the main system messages file at runtime.

At the moment the IdP presents itself as "Example University". If this needs to be changed then the [messages.properties](messages/messages.properties) is the place to do it (it could be made more dynamic but this would require the logo image to be selected/generated too, which is not core to the purpose of this IdP container).
